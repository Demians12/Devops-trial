{
  "title": "Available Schedules — Latency & Errors",
  "schemaVersion": 39,
  "version": 2,
  "timezone": "",
  "time": { "from": "now-6h", "to": "now" },
  "panels": [
    {
      "type": "timeseries",
      "title": "RPS (req/s)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
      "targets": [
        {
          "expr": "sum(rate(http_requests_total{job=~\"available-schedules-(python|go)\", route=~\"$route\"}[5m]))",
          "instant": false
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Error rate 5xx (%)",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
      "targets": [
        {
          "expr": "100 * sum(rate(http_requests_total{job=~\"available-schedules-(python|go)\",status=~\"5..\", route=~\"$route\"}[5m])) / sum(rate(http_requests_total{job=~\"available-schedules-(python|go)\", route=~\"$route\"}[5m]))",
          "instant": false
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Latency p95 por serviço",
      "description": "Os histogram buckets de latência (http_request_duration_seconds_bucket) não expõem o label route; portanto o p95 é calculado por serviço/job (Python/Go) para manter fidelidade aos dados disponíveis.",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, job) (rate(http_request_duration_seconds_bucket{job=~\"available-schedules-(python|go)\"}[5m])))",
          "instant": false
        }
      ]
    },
    {
      "type": "table",
      "title": "Percentual de 5xx por rota",
      "description": "Percentual de respostas 5xx por rota, calculado a partir de http_requests_total (route está disponível nesta métrica).",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
      "targets": [
        {
          "expr": "100 * sum by (route) (increase(http_requests_total{job=~available-schedules-python|available-schedules-go,status=~5..,route=~$route}[5m])) / clamp_min(sum by (route) (increase(http_requests_total{job=~available-schedules-python|available-schedules-go,route=~$route}[5m])), 1)"
        }
        ],
      "transformations": [],
      "options": { "showHeader": true }
    }
  ],
  "templating": {
    "list": [
      {
        "type": "query",
        "name": "route",
        "label": "Route",
        "query": "label_values(http_requests_total{job=~\"available-schedules-(python|go)\"}, route)",
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      }
    ]
  }
}